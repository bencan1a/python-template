# üìã Agent Documentation Contract

This document defines the documentation folder structure and rules for both human developers and AI agents working on this project.

## Folder Structure and Purposes

| Folder | Purpose | Persistence | Committed to Git |
|--------|---------|-------------|------------------|
| `agent-tmp/` | Scratch / debug / intermediates | Ephemeral (auto-cleaned) | ‚ùå No (gitignored) |
| `agent-plans/<project>/` | Ephemeral plan docs for refactors, experiments, migrations | Short-lived | ‚úÖ Yes |
| `docs/` | Permanent, canonical documentation | Persistent | ‚úÖ Yes |
| `docs/_generated/` | Auto-generated documentation | Auto-updated | ‚úÖ Yes (auto-committed) |

## Folder Rules

### `agent-tmp/` - Temporary Workspace
- **Purpose**: Scratch files, debugging scripts, intermediate outputs
- **Rules**:
  - Agents may freely create or delete files here
  - Nothing in this folder is committed to git (gitignored)
  - Files older than 7 days are automatically pruned by automation
- **Examples**: Debug logs, temporary analysis scripts, work-in-progress calculations

### `agent-plans/<project>/` - Ephemeral Plans
- **Purpose**: Short-lived planning documents for specific refactors, experiments, or migrations
- **Rules**:
  - Each plan has its own subfolder (e.g., `agent-plans/feature-xyz/`)
  - Each plan must have a `plan.md` file with required metadata
  - Only "active" plans less than 21 days old are summarized in generated docs
  - Completed or old plans remain in history but are ignored by automation
- **Required Metadata** in `plan.md`:
  ```yaml
  status: active|paused|done
  owner: <name>
  created: YYYY-MM-DD
  summary:
    - short bullet
    - another bullet
  ```

### `docs/` - Permanent Documentation
- **Purpose**: Single source of truth for all permanent project documentation
- **Rules**:
  - This is the canonical location for all long-term documentation
  - Agents should prefer this folder when writing permanent docs
  - All documentation here is version-controlled
  - Files should be well-organized and clearly named
- **Examples**: Architecture guides, API docs, user guides, decision records

### `docs/_generated/` - Auto-Generated Documentation
- **Purpose**: Documentation automatically generated from code, schemas, and active plans
- **Rules**:
  - Files here are automatically generated by `tools/build_context.py`
  - Do not manually edit files in this directory
  - Generated on every relevant code/doc change and nightly
  - Auto-committed by GitHub Actions
- **Contents**:
  - API documentation (from Python docstrings via pdoc3)
  - Schema documentation
  - Active plans summary (`plans_index.md`)

## Primary Documentation Files

### For Agents to Read
- **`docs/CONTEXT.md`** - Single canonical context file; main entry point for agents
- **`docs/SUMMARY.md`** - Quick index of all documentation components
- **`docs/facts.json`** - Stable, hand-maintained truths about the project
- **`docs/_generated/`** - Auto-generated API docs, schemas, and active plans

### Trust Hierarchy (when information conflicts)
1. `docs/facts.json` (highest authority)
2. Permanent content in `docs/`
3. Active plans summaries (hints only)

## Automation

### Build Process
The `tools/build_context.py` script:
1. Regenerates API docs from Python docstrings (using pdoc3)
2. Summarizes active plans (status=active, created within 21 days)
3. Merges everything into `docs/CONTEXT.md` (capped at ~150 KB)
4. Updates `docs/SUMMARY.md` with component list and timestamp
5. Appends an entry to `docs/CHANGELOG.md`
6. Prunes `agent-tmp/` files older than 7 days

### GitHub Action (`.github/workflows/docs.yml`)
- **Triggers**:
  - Push events that change source, schema, or docs files
  - Scheduled nightly at 2 AM UTC
- **Actions**:
  - Runs `tools/build_context.py`
  - Auto-commits updated documentation
  - No manual approval required

### Environment Variables
```yaml
CONTEXT_MAX_CHARS: "150000"    # Max size of CONTEXT.md
PLANS_MAX_AGE_DAYS: "21"       # Max age for "active" plans
CLEAN_TMP_AGE_DAYS: "7"        # Max age for agent-tmp files
```

## Agent Operating Guidelines

### When Reading Documentation
1. Start with `docs/CONTEXT.md` for comprehensive context
2. Check `docs/SUMMARY.md` for quick navigation
3. Consult `docs/facts.json` for stable project truths
4. Review `docs/_generated/plans_index.md` for active work
5. Trust the hierarchy: facts.json > permanent docs > active plans

### When Writing Documentation

#### Permanent Knowledge
- Write to or update files under `docs/`
- Use clear, descriptive filenames
- Keep documentation synchronized with code
- Update existing docs rather than duplicating information

#### Ephemeral Plans/Tasks
- Create a new subfolder: `agent-plans/<project-name>/`
- Write `plan.md` with required metadata fields
- Include detailed planning, research, and progress notes
- Update status when work is complete or paused

#### Temporary Work
- Use `agent-tmp/` for all scratch work
- Never commit files from `agent-tmp/`
- Don't rely on these files persisting long-term

### When Updating Documentation
- The nightly automation will refresh generated docs automatically
- To manually regenerate: `python tools/build_context.py`
- Each refresh updates `CHANGELOG.md` with timestamp and source SHA

## Success Criteria

‚úÖ Documentation system is working correctly when:
- Running `python tools/build_context.py` produces updated `docs/CONTEXT.md` with correct front-matter
- GitHub Actions auto-commit doc updates when changes occur
- Active plans appear in `docs/_generated/plans_index.md` within 24 hours
- Agents can navigate and update docs following these rules
- Old temporary files are automatically cleaned up

## Goals

This system creates a **self-healing documentation loop** where:
- Agents always operate from up-to-date context
- Permanent docs stay consistent with code
- Ephemeral plan content decays naturally without polluting long-term knowledge
- Documentation builds are reproducible and auditable
